h1. Cream module

A module that seamlessly integrates Apache Jackrabbit (JCR 2.0) with Play framework.

h2. <a name="fts">Features</a>

* OCM
** Uses jcrom as the underlying object-to-content mapper

* Content version management

* Full text search
** Indexing PDF, MS Word, Excel, PowerPoint, OpenOffice, RTF, HTML and XML

* play.db.Model support

* CRUD support

* Data binding and validation

h2. <a name="usg">Usage</a>

Install locally this module

bc.. $ play install cream-{version}

p. Declare the proper dependency in conf/dependencies.yml

bc.. require:
    - play
    - play -> cream {version}
    
p. and let Play download and install the dependencies 

bc.. $ play deps
    
p. Configure Cream in conf/application.conf

bc.. ## Cream module configuration
cream.jcr.url=file://tmp-repo
cream.jcr.username=admin
cream.jcr.password=admin
cream.jcr.workspace=default
# Path to your jackrabbit configuration.
# A default configuration will be used 
# if you don't specify any
#cream.jcr.configuration=conf/cream-repository.xml 

## Testing
%test.cream.jcr.mode=transient

p. Annotate your model classes and extend play.modules.cream.Model (not required but convenient). See jcrom and Play validation for extended details.

bc.. @JcrNode(mixinTypes = { "mix:created", "mix:lastModified", "mix:referenceable" })
public class User extends Model {

    @JcrName // this is the node name
    @Required
    public String name; 

    @JcrProperty
    @Required
    @Email
    public String email;

    @JcrProperty
    @MinSize(5)
    public String password;
    
    ...
}

p. Note: model classes managed by Cream plugin must be annotated with @JcrNode (normally with at least mix:referenceable) but jcrom doesn't require it.

You need to open a jcr session in order to access the model from the controllers. To achieve it you have these options:

1) Annotate a Controller with @JcrSession

bc.. @JcrSession
public class Application extends Controller {
    ...
}

p. 2) Inject a session in the Controller with @Inject

bc.. public class Application extends Controller {

    @Inject
    static javax.jcr.Session jcrSession;
    
    ...
}

p. 3) Do it manually

bc.. public void someMethod() {
    Session session = JcrPlugin.getCurrentSession();
    try {
        ...
    } finally {
        session.logout();
    }
}

p. An example of Controller

bc.. @JcrSession
public class MyController extends Controller {
    
    ...
    
    public static void create(@Valid MyEntity entity) {
       if (validation.hasErrors()) {
            validation.keep();
            params.flash();
            flash.error("Please correct these errors !");
            add(entity);
       }
       
       entity.path = "/path";
       entity.create();
       
       index(1);
    }
    
    public static void index(Integer page) {
        
        JcrQuery result = MyEntity.findAll("/path");
        long nbMyEntity = result.count();
        List<MyEntity> entities = result.fetch(page, pageSize);
        
        
        // Unsafe assignation, use RenderArgs instead :P
        page = (page != null) ? Math.max(page, 1) : 1; 
        render(nbMyEntity, entities, page);
   }
   
   ...
}

p. Note: if you don't specify a jcr path the simple class name will be used by default.

See cream/samples-and-test for more examples...

p. To use Cream with CRUD simply annotate your  Controller with @JcrSession

bc.. @JcrSession
public class Users extends CRUD {

}

p. You can use Fixtures normally for your tests and initial data loading.

h2. <a href="sch">Full Text Search</a>

Jackrabbit is able to index binary content and text, of course. http://jackrabbit.apache.org/jackrabbit-text-extractors.html

Full text search is achieved by the means of the contains clause:

bc.. # 6.7.19 FullTextSearch (p 113)
select * from test where contains(name, 'hello -world')
select * from test where contains(name, $x)
select * from test as t where contains(t.*, 'hello -world')
select * from test as t where contains([t].name, 'hello -world')

p. Score:

bc.. # 6.7.31 FullTextSearchScore (p 122)
select * from test where score()>4
select * from test as x where score(x)<1

p. Result excerpts. Still not supported in Jackrabbit 2. However you can use the old syntax, for example:

bc..  // XXX see
            // http://jackrabbit.510166.n4.nabble.com/Use-of-excerpt-with-SQL2-td3249018.html
            // waiting for excerpt support with SQL-2
            try {
                QueryManager qm = JcrPersistence.getQueryManager();
                @SuppressWarnings("deprecation")
                Query q = qm.createQuery(
                        "select excerpt(.) from nt:unstructured where jcr:path like '/mypath/%' and contains(., '"
                                + search + "') order by jcr:score desc", Query.SQL);
                QueryResult result = q.execute();
                for (RowIterator it = result.getRows(); it.hasNext();) {
                    Row r = it.nextRow();
                    Value excerpt = r.getValue("rep:excerpt(.)");
                    ...
                }

            } catch (RepositoryException e) {
                Logger.error(e.getMessage(), e);
            }

p. For a pragmatic reference of SQL-2 take a look at the official Jackrabbit tests: http://svn.apache.org/viewvc/jackrabbit/trunk/jackrabbit-spi-commons/src/test/resources/org/apache/jackrabbit/spi/commons/query/sql2/test.sql2.txt?view=markup

p. Have fun! // and more to come...

